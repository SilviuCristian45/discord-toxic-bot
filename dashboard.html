<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToxicGuard Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #3b82f6; text-align: center; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Layout Grid pentru Grafice */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* DouƒÉ coloane egale */
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; } /* Pe mobil una sub alta */
        }

        .chart-card {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid #333;
        }

        h2 { font-size: 1.1rem; color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }

        /* Tabel */
        .table-container {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
            border: 1px solid #333;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2a2a2a; font-size: 0.9rem; }
        th { color: #888; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        tr:last-child td { border-bottom: none; }
        
        .toxic { color: #ef4444; font-weight: bold; }
        .safe { color: #10b981; }
        .latency-badge { background: #252525; padding: 3px 8px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìä Panou de Control & Statistici</h1>

    <div class="charts-grid">
        <div class="chart-card">
            <h2>‚è±Ô∏è Timp de RƒÉspuns (Laten»õƒÉ Procesare)</h2>
            <canvas id="latencyChart"></canvas>
        </div>

        <div class="chart-card">
            <h2>üë• √éncƒÉrcare Server (Useri Conecta»õi)</h2>
            <canvas id="usersChart"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h2>üìú Istoric Detaliat</h2>
        <table id="logsTable">
            <thead>
                <tr>
                    <th>Data/Ora</th>
                    <th>User</th>
                    <th>Mesaj Transcris</th>
                    <th>Laten»õƒÉ totala (ms)</th>
                    <th>Rezultat</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    let chartLatency = null;
    let chartUsers = null;

    async function loadData() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            // DacƒÉ e gol, nu facem nimic
            if (!data || data.length === 0) return;

            // LuƒÉm ultimele 50 de √ÆnregistrƒÉri pentru grafic
            const recentData = data.slice(-50);

            // Extragem datele pentru Chart.js
            const labels = recentData.map(row => row.timestamp.split(" ")[1]); // Ora HH:MM:SS
            const latencyData = recentData.map(row => parseFloat(row.latency_ms));
            const userData = recentData.map(row => parseInt(row.user_count));
			const sttData = recentData.map(row => parseFloat(row.stt_time));
			const aiData = recentData.map(row => parseFloat(row.ai_time));

            // --- CONFIGURARE GRAFIC 1 (LATEN»öA) ---
            const ctxLatency = document.getElementById('latencyChart').getContext('2d');
            
            if (chartLatency) {
                chartLatency.data.labels = labels;
                chartLatency.data.datasets[0].data = latencyData;
                chartLatency.update();
            } else {
                chartLatency = new Chart(ctxLatency, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'STT + AI (ms)',
                            data: latencyData,
                            borderColor: '#3b82f6', // Albastru
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.3, // Linie curbƒÉ
                            fill: true,
                            pointRadius: 3
                        }, {
							label: 'Timp STT - Whisper Tiny (ms)',
                            data: sttData,
                            borderColor: '#ef4444', // Rosu
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.3, // Linie curbƒÉ
                            fill: true,
                            pointRadius: 3
						}, {
							label: ' Timp predictie Bert (ms)',
                            data: aiData,
                            borderColor: '#f97316', // Portocaliu
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 2,
                            tension: 0.3, // Linie curbƒÉ
                            fill: true,
                            pointRadius: 3
						}]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#333' } },
                            x: { grid: { display: false } }
                        },
                        plugins: { legend: { display: true } },
						
                    }
                });
            }

            // --- CONFIGURARE GRAFIC 2 (USERI) ---
            const ctxUsers = document.getElementById('usersChart').getContext('2d');

            if (chartUsers) {
                chartUsers.data.labels = labels;
                chartUsers.data.datasets[0].data = userData;
                chartUsers.update();
            } else {
                chartUsers = new Chart(ctxUsers, {
                    type: 'bar', // Bar Chart
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Useri Activi',
                            data: userData,
                            backgroundColor: '#f97316', // Portocaliu
                            borderRadius: 4,
                            barThickness: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#333' } },
                            x: { grid: { display: false } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // --- POPULARE TABEL ---
            const tableBody = document.querySelector("#logsTable tbody");
            tableBody.innerHTML = ""; // CurƒÉ»õƒÉm tabelul √Ænainte de redraw

            // InversƒÉm ca sƒÉ vedem ultimele primele
            data.slice().reverse().forEach(row => {
                const tr = document.createElement("tr");
                const isToxic = row.toxic_labels !== "SAFE" && row.toxic_labels !== "";
                
                tr.innerHTML = `
                    <td style="color: #666;">${row.timestamp}</td>
                    <td style="font-weight: bold;">${row.user}</td>
                    <td style="color: #ccc;">${row.text}</td>
                    <td><span class="latency-badge">${parseFloat(row.latency_ms).toFixed(0)} ms</span></td>
                    <td class="${isToxic ? 'toxic' : 'safe'}">
                        ${isToxic ? "‚ö†Ô∏è BLOCAT (" + row.toxic_labels + ")" : "‚úÖ SAFE"}
                    </td>
                `;
                tableBody.appendChild(tr);
            });

        } catch (error) {
            console.error("Eroare la √ÆncƒÉrcarea datelor:", error);
        }
    }

    // Pornim
    loadData();
    // Refresh la fiecare 3 secunde
    setInterval(loadData, 3000);

</script>

</body>
</html>